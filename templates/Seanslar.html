<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seans Ekle</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

    {% include 'navbar.html' %}

    <div class="container mt-4" style="max-width: 900px;">
        <h2 class="text-center mb-4">â• Yeni Seans Ekle</h2>
        <form id="seansForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="session_name" class="form-label">Seans TÃ¼rÃ¼:</label>
                        <input type="text" id="session_name" name="session_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="session_date" class="form-label">BaÅŸlangÄ±Ã§ Tarihi:</label>
                        <input type="date" id="session_date" name="session_date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="seans_gunleri" class="form-label">Seans GÃ¼nleri:</label>
                        <select id="seans_gunleri" name="seans_gunleri" class="form-control" multiple required>
                        <option value="Pazartesi">Pazartesi</option>
                        <option value="SalÄ±">SalÄ±</option>
                        <option value="Ã‡arÅŸamba">Ã‡arÅŸamba</option>
                        <option value="PerÅŸembe">PerÅŸembe</option>
                        <option value="Cuma">Cuma</option>
                        <option value="Cumartesi">Cumartesi</option>
                        <option value="Pazar">Pazar</option>
                    </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="session_time" class="form-label">Seans Saati:</label>
                        <input type="text" id="session_time" name="session_time" class="form-control" placeholder="Ã–rn: 10:00 - 11:30" required>
                    </div>
                    <div class="mb-3">
                        <label for="session_fee" class="form-label">Seans Ãœcreti (TL):</label>
                        <input type="number" id="session_fee" name="session_fee" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="session_count" class="form-label">Seans SayÄ±sÄ±:</label>
                        <input type="number" id="session_count" name="session_count" class="form-control" required>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100">ğŸ“© Kaydet</button>
        </form>
    </div>

    <div class="container mt-4" style="max-width: 900px;">
        <h2 class="text-center mb-4">ğŸ“‹ Eklenen Seanslar</h2>
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Seans TÃ¼rÃ¼</th>
                    <th>Tarih</th>
                    <th>GÃ¼n</th>
                    <th>Saati</th>
                    <th>Ãœcret (TL)</th>
                    <th>Seans SayÄ±sÄ±</th>
                    <th>Ä°ÅŸlem</th>
                </tr>
            </thead>
            <tbody id="seans_table">
                <tr><td colspan="7" class="text-center">Seans bulunamadÄ±!</td></tr>
            </tbody>
        </table>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
    fetchSeansList();  // SeanslarÄ± listele

    let seansGunleriElement = document.querySelector("#seans_gunleri");

    if (!seansGunleriElement) {
        console.error("âŒ HATA: #seans_gunleri bulunamadÄ±!");
        return;
    }

    document.querySelector("#seansForm").addEventListener("submit", function(event) {
        event.preventDefault();

        // Seans GÃ¼nleri elementinin bulunduÄŸundan emin ol
        let selectedDaysElement = document.querySelector("#seans_gunleri");
        if (!selectedDaysElement) {
            console.error("âŒ HATA: #seans_gunleri Ã¶ÄŸesi bulunamadÄ±!");
            return;
        }

        let selectedDays = Array.from(selectedDaysElement.selectedOptions).map(option => option.value);

        let payload = {
            session_name: document.querySelector("#session_name").value,
            session_date: document.querySelector("#session_date").value,
            session_time: document.querySelector("#session_time").value,
            session_fee: document.querySelector("#session_fee").value,
            session_count: document.querySelector("#session_count").value,
            session_days: selectedDays  // âœ… JSON formatÄ±nda gÃ¶nder
        };

        console.log("ğŸ“Œ GÃ¶nderilen Payload:", payload);

        fetch("/add_seans", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("âœ… Seans baÅŸarÄ±yla eklendi!", data);
                fetchSeansList();
                document.querySelector("#seansForm").reset();
            } else {
                alert("âš ï¸ Seans eklenirken hata oluÅŸtu: " + data.message);
            }
        })
        .catch(error => console.error("âš ï¸ Hata:", error));
    });
});


document.getElementById("seans_turu").addEventListener("change", function() {
    let selectedSeans = this.value;
    console.log("âœ… SeÃ§ilen Seans TÃ¼rÃ¼:", selectedSeans);

    fetch("http://127.0.0.1:5000/api/seans_takvimi")
        .then(response => response.json())
        .then(data => {
            let seans = data.find(s => s.session_name === selectedSeans);
            if (seans) {
                let fiyatInput = document.getElementById("seans_fiyat");
                let saatInput = document.getElementById("seans_saati");

                if (fiyatInput && saatInput) {
                    fiyatInput.value = seans.session_fee;
                    saatInput.value = seans.session_time;
                    console.log("âœ… Seans Bilgileri GÃ¼ncellendi:", seans);
                } else {
                    console.error("âŒ Form inputlarÄ± bulunamadÄ±!");
                }
            } else {
                console.log("âš ï¸ Seans BulunamadÄ±:", selectedSeans);
            }
        })
        .catch(error => console.error("âš ï¸ API HatasÄ±:", error));
});




// âœ… API'den SeanslarÄ± Ã‡ek ve Tabloya Ekle
function fetchSeansList() {
    fetch("/api/seanslar")
    .then(response => response.json())
    .then(data => {
        console.log("âœ… API'den Gelen Seans Verisi:", data);

        let seansTable = document.getElementById("seans_table");
        seansTable.innerHTML = "";  

        if (!data || data.length === 0) {
            seansTable.innerHTML = "<tr><td colspan='7' class='text-center'>Seans bulunamadÄ±!</td></tr>";
            return;
        }

        data.forEach(seans => {
            let daysValue;
            try {
                daysValue = Array.isArray(seans.days) ? seans.days.join(", ") : JSON.parse(seans.days).join(", ");
            } catch (e) {
                console.error("âš ï¸ GÃ¼nleri iÅŸlerken hata oluÅŸtu:", e);
                daysValue = seans.days || "TanÄ±msÄ±z"; // JSON hatasÄ± olursa dÃ¼z string gÃ¶ster
            }

            let row = document.createElement("tr");
            row.innerHTML = `
                <td>${seans.title}</td>
                <td>${seans.start}</td>
                <td>${daysValue}</td>
                <td>${seans.time}</td>
                <td>${seans.fee ? seans.fee.toLocaleString("tr-TR") + " TL" : "Bilinmiyor"}</td>
                <td>${seans.count || "Bilinmiyor"}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteSeans(${seans.id})">Sil</button>
                </td>
            `;
            seansTable.appendChild(row);
        });

        console.log("âœ… Seanslar baÅŸarÄ±yla tabloya eklendi!");
    })
    .catch(error => console.error("âš ï¸ SeanslarÄ± Ã§ekerken hata oluÅŸtu:", error));
}

// âœ… Seans Silme Fonksiyonu
function deleteSeans(seansId) {
    if (!confirm("Bu seansÄ± silmek istediÄŸinizden emin misiniz?")) return;

    fetch(`/delete_seans/${seansId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("âœ… Seans baÅŸarÄ±yla silindi!");
            fetchSeansList();  // GÃ¼ncellenmiÅŸ listeyi tekrar Ã§ek!
        } else {
            alert("âš ï¸ Silme iÅŸlemi baÅŸarÄ±sÄ±z: " + data.message);
        }
    })
    .catch(error => console.error("Seans silerken hata oluÅŸtu:", error));
}


    
    </script>

</body>
</html>
